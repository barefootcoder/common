#! /usr/bin/env perl

use 5.14.0;
use autodie ':all';
use warnings FATAL => 'all';

use Text::Tabs; $tabstop = 4;


my $pre_re = qr/^\.$/;

my $in_pre = 0;
my $in_list = 0;
while (<>)
{
	$_ = expand($_);

	if (( /$pre_re/ or /^\s+(.)/ and !($1 ~~ ['*','#']) ) and not $in_pre and not $in_list)
	{
		/$pre_re/ ? ($_ = "{{{\n") : say '{{{';
		$in_pre = 1;
		s/^    //;
	}
	elsif ($in_pre and ( /^$/ or /$pre_re/ ))
	{
		/$pre_re/ ? ($_ = "}}}\n") : say '}}}';
		$in_pre = 0;
	}
	elsif ($in_list and /^$/)
	{
		$in_list = 0;
	}
	elsif ($in_pre)
	{
		s/^    //;
	}
	else
	{
		s/^  (\s*\*\s+)/$1/ and $in_list = 1;							# bullet lists
		s/^  (\s*)#(\s+)/${1}1.$2/ and $in_list = 1;					# numbered lists
		s/^  // if $in_list and not /^\s+[*#]/;							# continuation of bullet items

		s/\*\b(.+?)\*(?=\W)/'''$1'''/g;									# bold
		s/(^|\W)_(.+?)_(\W|$)/$1''$2''$3/g;								# italics
	}

	print;
}
