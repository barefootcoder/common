#! /bin/bash

if [[ $(id -un) != "vagrant" ]]
then
	echo "must run this from your sandbox, stupid" >&2
	exit 1
fi

# need this for practically everything
bin/ssh-tunnels


# cpanm infrastructure
cpanm --sudo --self-upgrade
cpanm --sudo Digest::MD5::File File::chdir File::Find::Rule IO::All IPC::System::Simple JSON::XS local::lib 		\
		LWP::Simple List::AllUtils MyCPAN::App::DPAN YAML::XS


# update local::lib stuff
rm ~/.cpanm/build.log
extlib/install --quiet --notest


# Puppet
make sandbox-puppet


# datbase updates
dbname=localdev

# have to do the schema-diff first, or sometimes the other commands will fail
bin/dbschema-diff
echo -e "\n\nPlease run the above commands (if any) in your $dbname."
echo "I'll wait ..."
while true
do
	read
	echo -n "Are you ready to proceed? [y/N]  "
	read yn
	if [[ $yn == [yY]* ]]
	then
		break
	fi
done

bin/copy-database --from ceprod4 --to $dbname --base-tables --location-tables --partner-map-tables					\
		--table tblfake_user_data --remote-user $CE_REMOTE_USERNAME
bin/copy-available-offer-db-records
make elasticsearch-refresh
make cetest

# call our companion script
# (this is seprated out so it can also be called by new_sandbox)
update_user_records
