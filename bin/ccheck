#! /bin/bash

readonly me=${0##*/}													# slightly prettier than $0
readonly wikibase='http://confluence.rent.com/display'					# needed for checking wikify files


taint=$(perl -lne 'print "T" if /perl -T/; exit if $. > 1' $1)
#echo "url would be $(perl -lne 'print "'$wikibase'/$1/$2" if $. == 1 && /^==> (.+?):(.+?) <==$/' "$1")"

proj=rent
if [[ $(vconfig_directive Project) == "rent" ]]
then
	# get the name of the sandbox machine from the Unison pref file
	readonly sandbox=$(perl -lne 'print $1 if m{^root\s*=\s*ssh://(?:\w+@)?([\w.-]+)//}' ~/.unison/sandbox.prf)

	#unison -ui text -batch sandbox
	file="$(realpath "$1")"
	#file=${file/$proj/rent.com}
	echo
	ssh $sandbox perl -c$taint "$file"
else
	if realpath "$1" | grep -q blog
	then
		total=$(wc -w "$1" | awk '{print $1}')
		in_links=$(( total -  $(perl -0777 -pe 's{\[[^]]*?\|}{[}g' "$1" | wc -w) ))
		in_quotes=$(( total -  $(perl -0777 -pe 's{//--.*?--//}{}sg' "$1" | wc -w) ))
		in_notes=$(( total
			-  $(perl -0777 -pe 's{(?<![\\^])\[(.*?)(\|(.*?))?\]}{$3//$1}eg;s{\^\^\[.*?\]}{}g' "$1" | wc -w)
			- in_links ))							# cause we took those out too, so don't count them as notes words
		printf "%-20s %4d\n" "total words" $total
		printf "%-20s %4d\n" "- in links" $in_links
		printf "%-20s %4d\n" "- in blockquotes" $in_quotes
		printf "%-20s %4d\n" "- in footnotes" $in_notes
		printf "%-20s %4d\n" "net words" $(( total - in_links - in_quotes - in_notes ))
	elif [[ "$1" == xtrack_posts ]]
	then
		scp $1 heroscapers:bin
		ssh heroscapers perl5/perlbrew/perls/perl-5.14.2/bin/perl -c bin/$1
	else
		url=$(perl -lne 'print "'$wikibase'/$1/$2" if $. == 1 && /^==> (.+?):(.+?) <==$/' "$1")
		if [[ -n $url ]]
		then
			echo "got url! [$url]"
			# http://confluence.rent.com/display/Arch/Home
			wikify "$url" | diff -b "$1" -
		else
			perl -c$taint $1
			exit 0
		fi
	fi
fi
