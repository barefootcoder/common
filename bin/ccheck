#! /bin/bash

readonly me=${0##*/}													# slightly prettier than $0
readonly wikibase='http://confluence.rent.com/display'					# needed for checking wikify files


taint=$(perl -lne 'print "T" if /perl -T/; exit if $. > 1' $1)
#echo "url would be $(perl -lne 'print "'$wikibase'/$1/$2" if $. == 1 && /^==> (.+?):(.+?) <==$/' "$1")"

proj=rent
if [[ 1 == 0 && ( $VCTOOLS_SHELL == "proj:$proj" || $VCTOOLS_SHELL == "git" ) ]]
then
	# get the name of the sandbox machine from the Unison pref file
	readonly sandbox=$(perl -lne 'print $1 if m{^root\s*=\s*ssh://(?:\w+@)?([\w.-]+)//}' ~/.unison/sandbox.prf)

	#unison -ui text -batch sandbox
	file="$(realpath "$1")"
	#file=${file/$proj/rent.com}
	echo
	ssh $sandbox perl -c$taint "$file"
else
	if realpath "$1" | grep -q blog
	then
		wc -w "$1"
	else
		url=$(perl -lne 'print "'$wikibase'/$1/$2" if $. == 1 && /^==> (.+?):(.+?) <==$/' "$1")
		if [[ -n $url ]]
		then
			echo "got url! [$url]"
			# http://confluence.rent.com/display/Arch/Home
			wikify "$url" | diff -b "$1" -
		else
			perl -c$taint $1
			exit 0
		fi
	fi
fi
