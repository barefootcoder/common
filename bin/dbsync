#! /bin/bash

# This is designed to be run from cron, so use full paths for everything.
LOCALHOSTNAME=$(/usr/local/bin/localhostname)
if [[ -z $LOCALHOSTNAME ]]
then
	echo "$0: machine not set up yet" >&2
	exit 1
fi

lockfile=/tmp/$(basename $0).lock
(
	flock -x -w 5 99 || exit 1
	trap "/bin/rm -f $lockfile" EXIT

	for dir in mozilla config thunderbird
	do
		if [[ -d ~/Dropbox/machine/$LOCALHOSTNAME/$dir ]]
		then
			/usr/bin/rsync -az --delete --exclude=global-messages-db.sqlite										\
					--exclude=lock --exclude=CacheStorage --exclude='Safe Browsing'								\
					~/.$dir/ ~/Dropbox/machine/$LOCALHOSTNAME/$dir/
		fi
	done


	# machine specific stuff
	case $LOCALHOSTNAME in
	#	cibola)		src_dir=~/work
	#				find_large_logs="find $src_dir/ -name *.log -size +32M -printf "'%P\n'
	#				rsync -az --exclude-from=<($find_large_logs) $src_dir/ ~/Dropbox/work/ce/
	#				;;
	esac

) 99>$lockfile
