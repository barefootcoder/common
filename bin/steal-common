#! /bin/bash

source ~/bin/bash_funcs


doit=true
while getopts ":nh" opt
do
	case $opt in
		n)	doit=false
			;;
		h)  echo "usage: $me -h | [-n] <host> <file> [...]" >&2
			echo "    -n : don't actually do the copy" >&2
			echo "    -h : this help message" >&2
			echo "    host : name of host to steal file from" >&2
			echo "    file : file(s) to steal" >&2
			exit
			;;
		:)  usage_erorr "$OPTARG requires an argument"
			;;
		\?) usage_error "unknown argument $OPTARG"
			;;
	esac
done
shift $(( $OPTIND - 1 ))

HERE=$LOCALHOSTNAME
THERE=$1
shift

[[ $THERE ]] || usage_error "must supply hostname to steal from"
[[ $# -ge 1 ]] || usage_error "give me at least one file to steal"

[[ $HERE == $THERE ]] && die "can't steal from myself"
[[ -d ~/Dropbox/machine/$THERE ]] || die "never heard of machine $THERE"


function diffit
{
	diff $mydir/$file $otherdir/$file | ${PAGER:-less}
}

function stealit
{
	if $doit
	then
		cp $otherdir/$file $mydir/$file
	else
		echo "would: cp $otherdir/$file $mydir/$file"
	fi
}

mydir=~/common
otherdir=~/Dropbox/machine/$THERE/common
cd $mydir

for file
do
	[[ -r $otherdir/$file ]] || die "can't read file $file on $THERE"
	if [[ -e $mydir/$file ]]
	then
		[[ -w $mydir/$file ]] || die "don't have permission to overwrite $file locally"
		if [[ $(git diff $mydir/$file | wc -l) -eq 0 ]]
		then
			if diffit
			then
				die "files are not different; nothing to steal"
			fi
			echo ''
			if yn "Overwrite the existing file?"
			then
				stealit
			fi
		else
			warn "$file has uncommitted changes; will not overwrite"
			if yn "Do the diff anyway?"
			then
				diffit
			fi
		fi
	else
		[[ -w $(dirname $mydir/$file) ]] || die "can't write to the dir of $file locally"
		stealit
	fi
done
