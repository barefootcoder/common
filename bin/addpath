#! /usr/bin/perl

use Getopt::Std;
use File::Basename;


getopts('fseb:BDh');

if ($opt_h)
{
	print STDERR "usage: ", basename($0), " -h | [-sfe] [-B | -b env_var] [dir ...]\n";
	print STDERR "       -s : return dirs separated by space (default: colon)\n";
	print STDERR "       -f : add dir(s) to front of list instead of back\n";
	print STDERR "       -e : output shell commands suitable for eval'ing\n";
	print STDERR "       -b : use this env_var's value as the base list to add to [default: \$PATH]\n";
	print STDERR "       -B : start with a blank base list\n";
	print STDERR "       -D : print some debugging messages (to stderr)\n";
	print STDERR "       -h : this help message\n";
	print STDERR "     dirs that do not exist and duplicate dirs are removed from the list\n";
	print STDERR "     this is true even if the dirs are in the base list instead of the supplied list\n";
	exit;
}

$opt_b ||= 'PATH';
unless ($opt_B)
{
	@dirs = split(':', $ENV{$opt_b});
	%dirs = map { $_ => 1 } @dirs;
}

foreach $dir (@ARGV)
{
	if ($dir and not exists $dirs{$dir} and -d $dir)
	{
		push @newdirs, $dir;
		$dirs{$dir} = 1;
	}
}
if ($opt_f)
{
	$opt_D and print "unshifting ", scalar(@dirs), " dirs into $opt_b\n";
	unshift @dirs, @newdirs;
}
else
{
	$opt_D and print "pushing ", scalar(@dirs), " dirs onto $opt_b\n";
	push @dirs, @newdirs;
}

my $out = join($opt_s ? ' ' : ':', @dirs);
if ($opt_e)
{
	print set_for_shell($opt_b, $out);
}
else
{
	print $out;
}


sub set_for_shell
{
	my ($base, $path) = @_;

	eval
	{
		require Shell::Guess;
		require Shell::Config::Generate;
		$opt_D and print "using Shell:Guess et al\n";

		my $conf = Shell::Config::Generate->new;
		$conf->set($base, $path);
		return $conf->generate;											# should be for the shell that called us
	};
	if ($@ =~ /Can't locate Shell/)										# fallback to old stupid way
	{																	# if we don't have the cool modules installed
		$opt_D and print "guessing at shell based on $ENV{SHELL}\n";
		if ($ENV{SHELL} =~ /csh/)
		{
			return "setenv $base $path";
		}
		else
		{
			return "export $base=$path";
		}
	}
	elsif ($@)
	{
		die;
	}
}
